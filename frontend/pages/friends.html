<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends - AnotherMe</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        'primary-dark': '#4F46E5',
                        'primary-light': '#A5B4FC',
                        'accent-purple': '#A855F7',
                        'accent-teal': '#14B8A6',
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header Navigation -->
    <div id="app-header"></div>

    <div id="app" class="pt-20 pb-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">

            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Friends</h1>
                <p class="text-gray-600">
                    Connect with people born on <span class="font-semibold text-primary">{{ userBirthday }}</span>
                </p>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
                <div class="flex border-b border-gray-200">
                    <button
                        @click="activeTab = 'twins'"
                        :class="[
                            'flex-1 px-6 py-4 text-sm font-medium transition',
                            activeTab === 'twins'
                                ? 'text-primary border-b-2 border-primary bg-primary/5'
                                : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                        ]"
                    >
                        ðŸŽ‚ Birthday Twins ({{ stats.twins }})
                    </button>
                    <button
                        @click="activeTab = 'friends'"
                        :class="[
                            'flex-1 px-6 py-4 text-sm font-medium transition',
                            activeTab === 'friends'
                                ? 'text-primary border-b-2 border-primary bg-primary/5'
                                : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                        ]"
                    >
                        ðŸ‘¥ My Friends ({{ stats.friends }})
                    </button>
                </div>
            </div>

            <!-- Birthday Twins Tab -->
            <div v-if="activeTab === 'twins'">
                <!-- Filters -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Filters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Gender Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                            <select
                                v-model="filters.gender"
                                @change="applyFilters"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                                <option value="">All</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- City Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                            <input
                                v-model="filters.city"
                                @input="applyFilters"
                                type="text"
                                placeholder="Search by city..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                        </div>

                        <!-- Region Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Region</label>
                            <input
                                v-model="filters.region"
                                @input="applyFilters"
                                type="text"
                                placeholder="Search by region..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                        </div>

                        <!-- Country Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                            <input
                                v-model="filters.country"
                                @input="applyFilters"
                                type="text"
                                placeholder="Search by country..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                        </div>
                    </div>

                    <!-- Clear Filters -->
                    <div class="mt-4 flex justify-end">
                        <button
                            @click="clearFilters"
                            class="text-sm text-gray-600 hover:text-primary transition"
                        >
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Birthday Twins List -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div
                        v-for="twin in filteredTwins"
                        :key="twin.id"
                        class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition cursor-pointer"
                        @click="viewProfile(twin.id)"
                    >
                        <!-- Avatar -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-xl"
                                     :style="{ backgroundColor: getAvatarColor(twin.id) }">
                                    {{ getInitials(twin.full_name) }}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">{{ twin.full_name }}</h3>
                                    <p class="text-sm text-gray-500">{{ twin.display_name || '@' + twin.full_name.toLowerCase().replace(' ', '') }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Info -->
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-sm text-gray-600">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                {{ twin.gender }}
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                {{ twin.city }}, {{ twin.region }}, {{ twin.country }}
                            </div>
                            <div v-if="twin.mutual_friends > 0" class="flex items-center text-sm text-gray-600">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                {{ twin.mutual_friends }} mutual friend{{ twin.mutual_friends > 1 ? 's' : '' }}
                            </div>
                        </div>

                        <!-- Bio Preview -->
                        <p v-if="twin.bio" class="text-sm text-gray-600 mb-4 line-clamp-2">
                            {{ twin.bio }}
                        </p>

                        <!-- Action Button -->
                        <button
                            v-if="twin.is_friend"
                            @click.stop="removeFriend(twin.id)"
                            class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition"
                        >
                            âœ“ Friends
                        </button>
                        <button
                            v-else
                            @click.stop="addFriend(twin.id)"
                            class="w-full px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition"
                        >
                            Add Friend
                        </button>
                    </div>

                    <!-- Empty State -->
                    <div v-if="filteredTwins.length === 0" class="col-span-full">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No birthday twins found</h3>
                            <p class="text-gray-600">Try adjusting your filters</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Friends Tab -->
            <div v-if="activeTab === 'friends'">
                <!-- Search Box -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <input
                        v-model="friendSearch"
                        type="text"
                        placeholder="Search friends by name..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                </div>

                <!-- Friends List -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div
                        v-for="friend in filteredFriends"
                        :key="friend.id"
                        class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition cursor-pointer"
                        @click="viewProfile(friend.id)"
                    >
                        <!-- Avatar -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-xl"
                                     :style="{ backgroundColor: getAvatarColor(friend.id) }">
                                    {{ getInitials(friend.full_name) }}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">{{ friend.full_name }}</h3>
                                    <p class="text-sm text-gray-500">{{ friend.display_name || '@' + friend.full_name.toLowerCase().replace(' ', '') }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Info -->
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-sm text-gray-600">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                {{ friend.gender }}
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                {{ friend.city }}, {{ friend.region }}, {{ friend.country }}
                            </div>
                        </div>

                        <!-- Bio Preview -->
                        <p v-if="friend.bio" class="text-sm text-gray-600 mb-4 line-clamp-2">
                            {{ friend.bio }}
                        </p>

                        <!-- Action Buttons -->
                        <div class="flex space-x-2">
                            <button
                                @click.stop="sendMessage(friend.id)"
                                class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition text-sm"
                            >
                                Message
                            </button>
                            <button
                                @click.stop="removeFriend(friend.id)"
                                class="px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg font-medium transition text-sm"
                            >
                                Remove
                            </button>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div v-if="filteredFriends.length === 0" class="col-span-full">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No friends yet</h3>
                            <p class="text-gray-600 mb-4">Start adding friends from your birthday twins!</p>
                            <button
                                @click="activeTab = 'twins'"
                                class="px-6 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition"
                            >
                                Find Birthday Twins
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="app-footer"></div>

    <!-- Scripts -->
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/navigation.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    user: null,
                    activeTab: 'twins',
                    twins: [],
                    friends: [],
                    friendSearch: '',
                    filters: {
                        gender: '',
                        city: '',
                        region: '',
                        country: ''
                    },
                    stats: {
                        twins: 0,
                        friends: 0
                    }
                };
            },
            computed: {
                userBirthday() {
                    if (!this.user) return '';
                    return this.formatBirthday(this.user.birth_date);
                },
                filteredTwins() {
                    let result = this.twins;

                    // Apply gender filter
                    if (this.filters.gender) {
                        result = result.filter(t => t.gender === this.filters.gender);
                    }

                    // Apply city filter
                    if (this.filters.city) {
                        result = result.filter(t =>
                            t.city.toLowerCase().includes(this.filters.city.toLowerCase())
                        );
                    }

                    // Apply region filter
                    if (this.filters.region) {
                        result = result.filter(t =>
                            t.region.toLowerCase().includes(this.filters.region.toLowerCase())
                        );
                    }

                    // Apply country filter
                    if (this.filters.country) {
                        result = result.filter(t =>
                            t.country.toLowerCase().includes(this.filters.country.toLowerCase())
                        );
                    }

                    return result;
                },
                filteredFriends() {
                    if (!this.friendSearch) return this.friends;

                    return this.friends.filter(f =>
                        f.full_name.toLowerCase().includes(this.friendSearch.toLowerCase())
                    );
                }
            },
            async mounted() {
                // Check authentication
                if (!requireAuth()) {
                    return;
                }

                // Load user data
                this.user = getCurrentUser();

                // Load data
                await this.loadData();
            },
            methods: {
                async loadData() {
                    try {
                        // Load birthday twins
                        const twins = await api.users.getBirthdayTwins();

                        // Load friends
                        const friends = await api.friends.getAll();
                        const friendIds = new Set(friends.map(f => f.id));

                        // Mark which twins are already friends
                        this.twins = twins.map(twin => ({
                            ...twin,
                            is_friend: friendIds.has(twin.id),
                            mutual_friends: 0 // TODO: Calculate mutual friends
                        }));

                        this.friends = friends;

                        // Update stats
                        this.stats.twins = this.twins.length;
                        this.stats.friends = this.friends.length;

                    } catch (error) {
                        console.error('Error loading data:', error);
                        if (error.message.includes('401')) {
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            window.location.href = '/pages/login.html';
                        }
                    }
                },
                applyFilters() {
                    // Filters are reactive via computed property
                },
                clearFilters() {
                    this.filters.gender = '';
                    this.filters.city = '';
                    this.filters.region = '';
                    this.filters.country = '';
                },
                async addFriend(userId) {
                    try {
                        await api.friends.add(userId);

                        // Update UI
                        const twin = this.twins.find(t => t.id === userId);
                        if (twin) {
                            twin.is_friend = true;
                            this.friends.push(twin);
                            this.stats.friends++;
                        }

                        if (typeof showToast !== 'undefined') {
                            showToast('Friend added successfully!', 'success');
                        }
                    } catch (error) {
                        console.error('Error adding friend:', error);
                        if (typeof showToast !== 'undefined') {
                            showToast('Failed to add friend: ' + error.message, 'error');
                        }
                    }
                },
                async removeFriend(userId) {
                    if (!confirm('Are you sure you want to remove this friend?')) return;

                    try {
                        await api.friends.remove(userId);

                        // Update UI
                        const twin = this.twins.find(t => t.id === userId);
                        if (twin) {
                            twin.is_friend = false;
                        }

                        this.friends = this.friends.filter(f => f.id !== userId);
                        this.stats.friends--;

                        if (typeof showToast !== 'undefined') {
                            showToast('Friend removed', 'success');
                        }
                    } catch (error) {
                        console.error('Error removing friend:', error);
                        if (typeof showToast !== 'undefined') {
                            showToast('Failed to remove friend: ' + error.message, 'error');
                        }
                    }
                },
                viewProfile(userId) {
                    // TODO: Navigate to profile page
                    console.log('View profile:', userId);
                    alert('Profile page coming soon!');
                },
                sendMessage(userId) {
                    // TODO: Navigate to messages page
                    console.log('Send message to:', userId);
                    window.location.href = `messages.html?user=${userId}`;
                },
                // Utility functions
                getInitials(name) {
                    if (!name) return '??';
                    const parts = name.trim().split(' ');
                    if (parts.length === 1) {
                        return parts[0].substring(0, 2).toUpperCase();
                    }
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                },
                getAvatarColor(userId) {
                    const colors = [
                        '#6366F1', '#A855F7', '#14B8A6', '#F59E0B',
                        '#EF4444', '#10B981', '#3B82F6', '#8B5CF6'
                    ];
                    const hash = userId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    return colors[hash % colors.length];
                },
                formatBirthday(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
